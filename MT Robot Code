/*
 * File:   MT_Robot_Code.c
 * Author: Corey Miles
 *
 * Created on October 29, 2025, 11:26 AM
 */

#include "xc.h"

// select oscillator
#pragma config FNOSC = LPRC // 31 khz

// global variables
int steps = 0;
int s = 0;

// OC1 Interrupt Service Routine
void __attribute__((interrupt, no_auto_psv)) _OC2Interrupt(void)
{
    // When the OC1 Interrupt is activated, the code will jump up here
    // each time your PIC generates a PWM step
    // Add code to clear the flag and increment the step count each time
    _OC2IF = 0;
    steps++;
}

int main(void) {
    
    // states
    enum { forward, full_turn, half_turn } state;
    
    // configure pins
    ANSB = 0;
    ANSA = 0;
    
    // configure output or input
    _TRISA0 = 0;
    _TRISA1 = 0;
    
    // set initial state of output pins
    _LATA0 = 1;
    _LATA1 = 0;
    
    // configure PWM
    OC2CON1 = 0x1C06;
    OC2CON2 = 0x001F;
    
    // PWM period
    OC2RS = 78;
        
    // duty cycle
    OC2R = 39;
    
    // initialize OC1
    _OC2IP = 4;
    _OC2IE = 1;
    _OC2IF = 0;
    
    // initialize state
    state = forward;
    
    // initialize while loop
    while(1){
        
        // state machine
        // forward state
        if (state == forward){
            
            // s = 0 for full_turn
            if (s == 0){
                
                // transition to full_turn
                if (steps >= 600){
                
                // change directions
                _LATA0 = 0;
                _LATA1 = 0;
                
                // set turning_steps
                steps = 0;
                
                // change state
                state = full_turn;
                
                }
                
            }
            
            // s = 1 for half-turn
            else{
                
                // transition to full_turn
                if (steps >= 600){
                
                // change directions
                _LATA0 = 0;
                _LATA1 = 0;
                
                // set turning_steps
                steps = 0;
                
                // change state
                state = half_turn;
                
                }
                
            }
            
        }
        
        // full_turn (180 degree) state
        if (state == full_turn){
                
            if (steps >= 290){
                
                // change directions
                _LATA0 = 1;
                _LATA1 = 0;
                
                // change s
                s = 1;
                
                // reset forward_steps
                steps = 0;
                
                // change state
                state = forward;
                
            }
        }
            
        // half_turn (90 degree) state
        if (state == half_turn){
            
            if (steps >= 140){
                
                // change directions
                _LATA0 = 1;
                _LATA1 = 0;
                
                // change s
                s = 0;
                
                // reset forward_steps
                steps = 0;
                
                // change state
                state = forward;
                
            }
        
        }
        
    }
            
return 0;

}
